
<html>
<script type="text/javascript" src="MapBuilder.js"></script>
<script type="text/javascript" src="BuilderCalculations.js"></script>
<script type="text/javascript" src="BuilderVisuals.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<link rel="stylesheet" type="text/css" href="MapBuilderStyles.css">

    <body>
	
		<div class="items" id="itemsArea"></div>

		<div class="stats">
				<span>Item Type: </span><span id='itemType'>0</span><br>
				<span>Rotation: </span><span id='rotation'>0</span><br>
				<div ><span>Coordenate: </span><span id='positionX'>0</span> , <span id='positionY'>0</span></div>
		</div>
		
		<div class="control">
			<button class="sideButton downloadButton" onclick='DownloadMap()'><i class="material-icons">download</i> Download</button>
			<button class="sideButton" onclick='ResetMap()'><i class="material-icons">delete</i> Reset Map</button>
		</div>
	
    </body>
    <script>
        var table;
        var itemType;
        var rotation;
        var positionX;
        var positionY;
		
		//Test List Of Shapes
		var listOfShapes = [
			new Vector2Array([0],[0]),
			new Vector2Array([0,0],[0,1]),
			new Vector2Array([0,0,1],[0,1,1])
		];
		
		var currentItemPlacingInfo = new ItemPlacingInfo();

        window.onload = function () {
			initializeMap(20, 40);
			initializeInputsAndOutputs();
			initializeItems();
        }
		
		function initializeInputsAndOutputs(x, y){
			AddListenerToScrollWheel(table);
	
            itemType = document.getElementById('itemType');
            rotation = document.getElementById('rotation');
            positionX = document.getElementById('positionX');
            positionY = document.getElementById('positionY');
		}
		
		function initializeMap(x, y){
			var tableID = "grid";
            
            table = generate_table(x, y);
			table.id = tableID;
			cells = document.getElementsByTagName("td");
			
            AddClickListenerToElement(table);
			AddHoverListenerToElements(cells);
			
			occupancyMap = Array(x).fill(null).map(()=>Array(y).fill(false));
		}
		
		function initializeItems(){
            var item;
			let itemsArea = document.getElementById('itemsArea');
			let defaultNames = ["Box", "Wall", "Corner Wall"];
			
			for(let i=0; i<3; i++){
				item = generate_table(4, 4);
				item.innerHTML += defaultNames[i];
				item.className = "item";
				itemsArea.appendChild( item );
				item.addEventListener('click', function(){ ChangeItem(i); } );
				
				let coordenates = GlobalizeCoordenates( listOfShapes[i] , 1, 1);
				printVisualsOfCoordenatesOnTable(coordenates, 'lightGreen', item);
				
			}
		}
		
///////////////////// MAIN ////////////////////////////////////////////////////
		
        function OnGridClick(x, y){
			//Resets Ctrl+Z actions
			chainedUndoneIndex = 0;
			
			//Creates an object {[x],[y]} where x and y are integrers
			var clickedCoordenate = new Vector2Array(x, y);
			
			if ( GetOccupancyOfCoordenates(clickedCoordenate) == OCCUPIED ){
				let itemPlacingInfo = FindHistoryInfoAtCoordenates(clickedCoordenate);
				console.log("Clicked on an item. Placing info:");
				console.log(itemPlacingInfo);
				DeleteFromHistoryOfPlacements(itemPlacingInfo);
				printVisualsOfCoordenates(itemPlacingInfo.coordenates, "white");
				UpdateOccupancy(itemPlacingInfo.coordenates, FREE);
			}
			else{
				console.log("Clicked on empty space");
				PlaceItemAtCurrentItemInfo();
			}
        }
		
		
		function PlaceItemAtCurrentItemInfo(){
			//make info
			let shape = listOfShapes[currentItemPlacingInfo.itemType];
			let shapeRotated = RotateCoordenatesByAngle(shape, currentItemPlacingInfo.rotation);
			let coordenates = GlobalizeCoordenates(shapeRotated, currentItemPlacingInfo.positionX, currentItemPlacingInfo.positionY);
			currentItemPlacingInfo.coordenates = coordenates;
			
			if(GetOccupancyOfCoordenates(coordenates) == FREE){
				console.log("CorrectPlacement");
				printVisualsOfCoordenates(coordenates, "green");
				UpdateOccupancy(coordenates, OCCUPIED);
				RegisterHistoryOfPlacements(currentItemPlacingInfo);
			}
			else{
				console.log("Incorrect Placement");
			}
			
			console.log("END OF PLACEMENT");
			console.log(coordenates);
		}

		function ChangeItem(itemIndex){
			currentItemPlacingInfo.itemType = itemIndex;
			itemType.innerHTML = currentItemPlacingInfo.itemType;
		
			console.log("Item changed to type: " + itemType.value);
		}
	    
		
		function DownloadMap(){
		
			let outputData = formatCoordenates();
			
			console.log("DOWNLOADED:");
			console.log(outputData);
            download("test"+ ".json", JSON.stringify(outputData));
        }	
/////////////////////////////////////////////////////////////////////////


    </script>
</html>